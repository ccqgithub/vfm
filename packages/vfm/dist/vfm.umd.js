var G=Object.defineProperty,H=Object.defineProperties;var J=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var Q=Object.prototype.hasOwnProperty,X=Object.prototype.propertyIsEnumerable;var K=(l,r,u)=>r in l?G(l,r,{enumerable:!0,configurable:!0,writable:!0,value:u}):l[r]=u,$=(l,r)=>{for(var u in r||(r={}))Q.call(r,u)&&K(l,u,r[u]);if(R)for(var u of R(r))X.call(r,u)&&K(l,u,r[u]);return l},w=(l,r)=>H(l,J(r));(function(l,r){typeof exports=="object"&&typeof module!="undefined"?r(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],r):(l=typeof globalThis!="undefined"?globalThis:l||self,r(l.VFM={},l.Vue))})(this,function(l,r){"use strict";class u{constructor(t,e){this.data=null,this.validate=null,this.validateCount=0,this.stopValidateWatcher=null,this.stopDirtyWatcher=null,this.isRegistered=!1;const{immediate:s=!0}=e;this.form=t,this.name=e.name,this._data=r.reactive({name:this.name,value:e.value===void 0?e.defaultValue:e.value,defaultValue:e.defaultValue,error:null,isError:!1,isValidating:!1,isDirty:!1,isTouched:!1,isChanged:!1}),this.data=r.readonly(this._data),this.validate=e.validate||null,s&&this.onRegister()}get state(){return this.data||(this.data=r.readonly(this._data)),this.data}initWatcher(){let t=null;this.stopValidateWatcher=r.watchEffect(async()=>{this.validateCount++;const e=this.state.value,s=this.form.state,a=this.validateCount;this._data.isValidating=!0,t==null||t(),t=null;let n=null;if(this.validate){const h=this.validate(e,s);h instanceof Promise&&(t=h.cancel||null),n=await h||null}if(a!==this.validateCount)return;this._data.isValidating=!1;const d=!!(n!=null&&n.message);d?(this._data.error||(this._data.error={message:""}),this._data.error.message=(n==null?void 0:n.message)||"",this._data.error.type=n==null?void 0:n.type):this._data.error=null,this._data.isError=d}),this.stopDirtyWatcher=r.watchEffect(()=>{this._data.isDirty=this._data.value!==this._data.defaultValue})}onRegister(){this.isRegistered||(this.initWatcher(),this.isRegistered=!0)}onUnregister(){var t,e;(t=this.stopValidateWatcher)==null||t.call(this),(e=this.stopDirtyWatcher)==null||e.call(this),this.isRegistered=!1}onChange(t){if(t===void 0)return;const e=this.state.value!==t;this._data.value=t,this._data.isChanged=this._data.isChanged||e}onTouched(t=!0){this._data.isTouched=t}reset(t){var e,s;this.validateCount++,(e=this.stopValidateWatcher)==null||e.call(this),(s=this.stopDirtyWatcher)==null||s.call(this),t!==void 0&&(this._data.defaultValue=t),this._data.error=null,this._data.isError=!1,this._data.isValidating=!1,this._data.isDirty=!1,this._data.isTouched=!1,this._data.isChanged=!1,this._data.value=this._data.defaultValue,this.initWatcher()}}class C{constructor(t,e){this.name="",this.data=null,this.validate=null,this.validateCount=0,this.stopValidateWatcher=null,this.isRegistered=!1;const{immediate:s=!0}=e;this.form=t,this.name=e.name,this._data=r.reactive({name:this.name,error:null,isError:!1,isValidating:!1}),this.data=r.readonly(this._data),this.validate=e.validate||null,s&&this.initWatcher()}get state(){return this.data||(this.data=r.readonly(this._data)),this.data}initWatcher(){let t=null;this.stopValidateWatcher=r.watchEffect(async()=>{this.validateCount++;const e=this.form.state,s=this.validateCount;this._data.isValidating=!0,t==null||t(),t=null;let a=null;if(this.validate){const d=this.validate(e);d instanceof Promise&&(t=d.cancel||null),a=await d||null}if(s!==this.validateCount)return;this._data.isValidating=!1;const n=!!(a!=null&&a.message);n?(this._data.error||(this._data.error={message:""}),this._data.error.message=(a==null?void 0:a.message)||"",this._data.error.type=a==null?void 0:a.type):this._data.error=null,this._data.isError=n})}onRegister(){this.isRegistered||(this.initWatcher(),this.isRegistered=!0)}onUnregister(){var t;(t=this.stopValidateWatcher)==null||t.call(this)}}const _=(i,t,e)=>{const s=t.split(".");let a=i;for(;s.length&&typeof a=="object"&&a!==null;){const n=s.shift();s.length===0?a[n]=e:(typeof a[n]!="object"||a[n]===null)&&(a[n]=/^\d+$/.test(n)?[]:{}),a=a[n]}},x=(i,t)=>{const e=t.split(".");let s=i;for(;e.length&&s;){const a=e.shift();s=typeof s=="object"&&s!==null?s[a]:void 0}return s},V=(i,t)=>{const e=t.split(".");let s=i;for(;e.length&&typeof s=="object"&&s!==null;){const a=e.shift();e.length===0?Array.isArray(s)?/^\d+$/.test(a)&&s.splice(Number(a),1):delete s[a]:s=s[a]}};class S{constructor(t){this.fieldsKeys=r.ref([]),this.fields=new Map,this.virtualFieldsKeys=r.ref([]),this.virtualFields=new Map,this.data=null,this._fieldStates=r.reactive({}),this._fieldStatesReadonly=null,this.stopStateWatcher=null,this.stopStatusWatcher=null,this.stopValidatingWatcher=null,this.waiters=[],this.defaultValues={},this.defaultValues=t.defaultValues||{},this._data=r.reactive({values:r.toRaw(this.defaultValues)||{},errors:{},virtualErrors:{},error:null,isError:!1,isValidating:!1,isDirty:!1,isTouched:!1,isChanged:!1,isSubmitted:!1,isSubmitting:!1,submitCount:0})}get state(){return this.data||(this.data=r.readonly(this._data)),this.data}get fieldStates(){return this._fieldStatesReadonly||(this._fieldStatesReadonly=r.readonly(this._fieldStates)),this._fieldStatesReadonly}mount(){this.stopStateWatcher=r.watchEffect(()=>{const t=this.fieldsKeys.value,e=this.virtualFieldsKeys.value;let s=!1,a=!1,n=!1,d=!1,h=!1,c=null;t.forEach(f=>{const o=this.fields.get(f);!o||(_(this._data.values,f,o.state.value),_(this._data.errors,f,o.state.error),_(this._fieldStates,f,o.state),o.state.isError&&(s=!0),o.state.isValidating&&(a=!0),o.state.isDirty&&(n=!0),o.state.isTouched&&(d=!0),o.state.isChanged||(h=!0),o.state.error&&!c&&(c=o.state.error))}),e.forEach(f=>{const o=this.virtualFields.get(f);!o||(_(this._data.virtualErrors,f,o.state.error),o.state.isError&&(s=!0),o.state.isValidating&&(a=!0),o.state.error&&!c&&(c=o.state.error))}),this._data.isError=s,this._data.error=c,this._data.isValidating=a,this._data.isDirty=n,this._data.isTouched=d,this._data.isChanged=h}),this.stopValidatingWatcher=r.watchEffect(()=>{this.state.isValidating||this.waiters.forEach(e=>{e()}),this.waiters=[]})}unmount(){var t,e,s;(t=this.stopStateWatcher)==null||t.call(this),(e=this.stopStatusWatcher)==null||e.call(this),(s=this.stopValidatingWatcher)==null||s.call(this);for(const a of this.fieldsKeys.value)this.unregisterField(a);for(const a of this.virtualFieldsKeys.value)this.unregisterVirtualField(a)}registerField(t,e={}){const{immediate:s=!0}=e,{fieldsKeys:a,fields:n}=this;if(a.value.includes(t))throw`Duplicate field <${t}>.`;for(const m of a.value)if(m.startsWith(`${t}.`)||t.startsWith(`${m}.`))throw`Fields can not be nested together: <${t}> <${m}>.`;const d=x(this.state.values,t);let h=e.value;h===void 0&&(h=d),h===void 0&&(h=e.defaultValue);const c=d===void 0?e.defaultValue:d,f=new u(this,w($({},e),{name:t,value:h,defaultValue:c})),o=()=>{n.set(t,f),this.fieldsKeys.value.push(t),f.initWatcher()};return s?(o(),{field:f,register:()=>{}}):{register:o,field:f}}registerVirtualField(t,e={}){const{immediate:s=!0}=e,{virtualFieldsKeys:a,virtualFields:n}=this;if(a.value.includes(t))throw`Duplicate virtual field <${t}>.`;const d=new C(this,w($({},e),{name:t})),h=()=>{n.set(t,d),this.virtualFieldsKeys.value.push(t)};return s?(h(),{field:d,register:()=>{}}):{register:h,field:d}}unregisterField(t){const{fields:e}=this,s=e.get(t);if(!s)throw`Field not exists <${t}>.`;s.onUnregister();const a=this.fieldsKeys.value.indexOf(t);a!==-1&&this.fieldsKeys.value.splice(a,1),V(this._data.values,t),V(this._data.errors,t),V(this._fieldStates,t),e.delete(t)}unregisterVirtualField(t){const{virtualFields:e}=this,s=e.get(t);if(!s)throw`Virtual field not exists <${t}>.`;s.onUnregister();const a=this.virtualFieldsKeys.value.indexOf(t);a!==-1&&this.virtualFieldsKeys.value.splice(a,1),V(this._data.virtualErrors,t),e.delete(t)}setValue(t,e){if(e===void 0)return;const s=this.fields.get(t);if(!s)throw`Field not exists <${t}>.`;s.onChange(e)}setTouched(t,e=!0){const s=this.fields.get(t);if(!s)throw`Field not exists <${t}>.`;s.onTouched(e)}submit(t,e){const s=()=>{if(this._data.isSubmitting=!1,this.state.isError){e(r.toRaw(this.state.errors));return}this._data.isSubmitted=!0,t(r.toRaw(this.state.values))};this._data.submitCount++,this._data.isSubmitting=!0,this.state.isValidating?this.waiters.push(()=>{s()}):s()}reset(t){this.waiters=[],this._data.values=t===void 0?this.defaultValues:t,this._data.errors={},this._data.virtualErrors={},this._data.error=null,this._data.isError=!1,this._data.isValidating=!1,this._data.isDirty=!1,this._data.isTouched=!1,this._data.isChanged=!1,this._data.isSubmitted=!1,this._data.isSubmitting=!1,this._data.submitCount=0;for(const[e,s]of this.fields){const a=x(this.state.values,e);s.reset(a)}}}const T=i=>new S(i),D=i=>{const t="{{name}} is not alphabetical";return typeof i!="string"?t:/^[a-zA-Z]*$/.test(i)?"":t},j=i=>{const t="{{name}} must be alpha-numeric";return typeof i!="string"&&typeof i!="number"?t:/^[a-zA-Z0-9]*$/.test(`${i}`)?"":t},z=i=>{const t="{{name}} must be decimal";return typeof i!="string"&&typeof i!="number"?t:/^[-]?\d*(\.\d+)?$/.test(`${i}`)?"":t},A=/^(?:[A-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[A-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9]{2,}(?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])$/i,M=i=>{const t="{{name}} is not a valid email address";return typeof i!="string"?t:A.test(i)?"":t},P=i=>{const t="{{name}} is not an integer";return typeof i!="string"&&typeof i!="number"?t:/(^[0-9]*$)|(^-[0-9]+$)/.test(`${i}`)?"":t},L=i=>{const t="{{name}} is not a valid IP address";if(typeof i!="string")return t;const e=i.split(".");return e.length===4&&e.every(q)?"":t},q=i=>{if(i.length>3||i.length===0||i[0]==="0"&&i!=="0"||!i.match(/^\d+$/))return!1;const t=+i;return t>=0&&t<=255},I=i=>{const t="{{name}} is not a valid MAC Address";if(typeof i!="string")return t;const e=":",s=i.split(e);return(s.length===6||s.length===8)&&s.every(U)?"":t},U=i=>i.toLowerCase().match(/^[0-9a-f]{2}$/),W={alpha:D,alphaNum:j,decimal:z,email:M,integer:P,ipAddress:L,macAddress:I,numeric:i=>{const t="{{name}} must be numeric";return typeof i!="string"&&typeof i!="number"?t:/^\d*(\.\d+)?$/.test(`${i}`)?"":t}},b=Symbol(),N=async(i,t,e)=>{if(i.required&&!t||i.requiredLength&&(typeof(t==null?void 0:t.length)!="number"||t.length<=0))return"{{name}} is required";if(i.minLength!==void 0&&(typeof(t==null?void 0:t.length)!="number"||t.length<i.minLength))return`{{name}}'s length cannot be less than ${i.minLength}`;if(i.maxLength!==void 0&&(typeof(t==null?void 0:t.length)!="number"||t.length>i.maxLength))return`{{name}}'s length cannot be greater than ${i.maxLength}`;if(i.min!==void 0&&(typeof t!="number"||t<i.min))return`{{name}} cannot be less than ${i.min}`;if(i.max!==void 0&&(typeof t!="number"||t>i.max))return`{{name}} cannot be greater than ${i.max}`;if(i.pattern&&(typeof t!="string"||!i.pattern.test(t)))return`{{name}} not match ${i.pattern.toString()}`;for(let s of i.validators||[])if(typeof s=="string"&&(s=W[s]),!s)console.warn(`validator ${s} is not registered`);else{const a=await s(t,e);if(a)return a}return""},E=i=>{const t=r.inject(b,null),{form:e=t,name:s,rules:a=[]}=i;if(!e)throw new Error(`No form in the injected context or props, can not use Field <${i.name}>`);const n=async(g,F)=>{let p=null;for(const y of a){const v=await N(y,g,F);if(v)return p=typeof v=="string"?{type:y.type,message:v}:v,p}return null},{register:d,field:h}=e.registerField(s,{value:i.value,defaultValue:i.defaultValue,validate:n,immediate:!1}),c=r.computed(()=>x(e.fieldStates,s)),f=r.computed(()=>c.value?c.value.value:h.state.value),o=g=>{var p,y;const F=typeof g=="object"&&typeof g.currentTarget=="object"&&typeof g.preventDefault=="function"&&((p=g.currentTarget)==null?void 0:p.value)!==void 0?(y=g.currentTarget)==null?void 0:y.value:g;e.setValue(s,F)},m=()=>{e.setTouched(s,!0)},Z=r.ref(null),B=g=>Z.value=g;return r.onMounted(()=>{d()}),r.onUnmounted(()=>{e.unregisterField(s)}),r.reactive({state:c,value:f,onChange:o,onBlur:m,setRef:B})},O=r.defineComponent({props:{form:null,name:null,rules:null,value:null,defaultValue:null},setup(i){const e=E(i);return(s,a)=>r.renderSlot(s.$slots,"default",r.normalizeProps(r.guardReactiveProps(r.unref(e))))}}),k=r.defineComponent({props:{form:null},setup(i){const t=i;return r.provide(b,t.form),(e,s)=>r.renderSlot(e.$slots,"default")}});l.Field=O,l.FieldClass=u,l.FormClass=S,l.FormProvider=k,l.VirtualFieldClass=C,l.createForm=T,l.useField=E,l.validators=W,l.vfmInjectionKey=b,Object.defineProperties(l,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
