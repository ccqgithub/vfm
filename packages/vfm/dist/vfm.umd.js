(function(f,n){typeof exports=="object"&&typeof module!="undefined"?n(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],n):(f=typeof globalThis!="undefined"?globalThis:f||self,n(f.VFM={},f.Vue))})(this,function(f,n){"use strict";var _t=Object.defineProperty,vt=Object.defineProperties;var wt=Object.getOwnPropertyDescriptors;var K=Object.getOwnPropertySymbols;var et=Object.prototype.hasOwnProperty,st=Object.prototype.propertyIsEnumerable;var tt=(f,n,v)=>n in f?_t(f,n,{enumerable:!0,configurable:!0,writable:!0,value:v}):f[n]=v,U=(f,n)=>{for(var v in n||(n={}))et.call(n,v)&&tt(f,v,n[v]);if(K)for(var v of K(n))st.call(n,v)&&tt(f,v,n[v]);return f},N=(f,n)=>vt(f,wt(n));var q=(f,n)=>{var v={};for(var A in f)et.call(f,A)&&n.indexOf(A)<0&&(v[A]=f[A]);if(f!=null&&K)for(var A of K(f))n.indexOf(A)<0&&st.call(f,A)&&(v[A]=f[A]);return v};const v=s=>{const t="{{name}} is not alphabetical";return typeof s!="string"?t:/^[a-zA-Z]*$/.test(s)?"":t},A=s=>{const t="{{name}} must be alpha-numeric";return typeof s!="string"&&typeof s!="number"?t:/^[a-zA-Z0-9]*$/.test(`${s}`)?"":t},it=s=>{const t="{{name}} must be decimal";return typeof s!="string"&&typeof s!="number"?t:/^[-]?\d*(\.\d+)?$/.test(`${s}`)?"":t},rt=/^(?:[A-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[A-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9]{2,}(?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])$/i,nt=s=>{const t="{{name}} is not a valid email address";return typeof s!="string"?t:rt.test(s)?"":t},at=s=>{const t="{{name}} is not an integer";return typeof s!="string"&&typeof s!="number"?t:/(^[0-9]*$)|(^-[0-9]+$)/.test(`${s}`)?"":t},lt=s=>{const t="{{name}} is not a valid IP address";if(typeof s!="string")return t;const e=s.split(".");return e.length===4&&e.every(ot)?"":t},ot=s=>{if(s.length>3||s.length===0||s[0]==="0"&&s!=="0"||!s.match(/^\d+$/))return!1;const t=+s;return t>=0&&t<=255},ut=s=>{const t="{{name}} is not a valid MAC Address";if(typeof s!="string")return t;const e=":",i=s.split(e);return(i.length===6||i.length===8)&&i.every(dt)?"":t},dt=s=>s.toLowerCase().match(/^[0-9a-f]{2}$/),T={alpha:v,alphaNum:A,decimal:it,email:nt,integer:at,ipAddress:lt,macAddress:ut,numeric:s=>{const t="{{name}} must be numeric";return typeof s!="string"&&typeof s!="number"?t:/^-?\d*(\.\d+)?$/.test(`${s}`)?"":t}},x=(s,t,e)=>{const i=t.split(".");let r=s;for(;i.length&&typeof r=="object"&&r!==null;){const a=i.shift();i.length===0?r[a]=e:(typeof r[a]!="object"||r[a]===null)&&(r[a]=/^\d+$/.test(a)?[]:{}),r=r[a]}},F=(s,t)=>{const e=t.split(".");let i=s;for(;e.length&&i;){const r=e.shift();i=typeof i=="object"&&i!==null?i[r]:void 0}return i},D=(s,t)=>{const e=t.split(".");let i=s;for(;e.length&&typeof i=="object"&&i!==null;){const r=e.shift();e.length===0?Array.isArray(i)?/^\d+$/.test(r)&&i.splice(Number(r),1):delete i[r]:i=i[r]}},M=(s,t,e=!0)=>{const i=Object.keys(s),r=Object.keys(t),a=i.filter(l=>!r.includes(l));e&&a.forEach(l=>{delete s[l]}),r.forEach(l=>{typeof s[l]=="object"&&!Array.isArray(s[l])&&s[l]!==null&&typeof t[l]=="object"&&!Array.isArray(t[l])&&t[l]!==null?M(s[l],t[l],e):s[l]=t[l]})},O=[String,Number,Boolean,Symbol,Array,Object],R=s=>{let t=[];const i=s(a=>{t.push(a)});return{promise:new Promise((a,l)=>{i.then(o=>{t=[],a(o)},o=>{t=[],l(o)})}),dispose:()=>{t.forEach(a=>a()),t=[]}}},C=(s,t)=>{let e=null,i=null,r=[];return async(...l)=>(e==null||e(),r.push(new Promise((o,d)=>{let u=null;const p=setTimeout(()=>{const c=s(...l);"promise"in c?(c.promise.then(o,d),u=()=>{var g;(g=c.dispose)==null||g.call(c)}):c.then(o,d)},t);e=()=>{u==null||u(),u=null,clearTimeout(p),d()}})),i||(i=(async()=>{for(;r.length;){const o=r.shift();try{const d=await o;if(!r.length)return d}catch(d){if(!r.length)throw d}}})(),i.finally(()=>{e=null,i=null,r=[]})))},z=(s,t,e)=>R(async i=>{if(s.required&&!t&&t!==0||s.requiredLength&&(typeof(t==null?void 0:t.length)!="number"||t.length<=0))return"{{name}} is required";if(s.minLength!==void 0&&(typeof(t==null?void 0:t.length)!="number"||t.length<s.minLength))return`{{name}}'s length cannot be less than ${s.minLength}`;if(s.maxLength!==void 0&&(typeof(t==null?void 0:t.length)!="number"||t.length>s.maxLength))return`{{name}}'s length cannot be greater than ${s.maxLength}`;if(s.min!==void 0&&(typeof t!="number"||t<s.min))return`{{name}} cannot be less than ${s.min}`;if(s.max!==void 0&&(typeof t!="number"||t>s.max))return`{{name}} cannot be greater than ${s.max}`;if(s.pattern&&(typeof t!="string"&&typeof t!="number"||!s.pattern.test(`${t}`)))return`{{name}} not match ${s.pattern.toString()}`;const r=Object.keys(T);for(const a of r)if(s[a]===!0){const o=T[a](t,e);typeof o=="object"&&"dispose"in o&&typeof o.dispose=="function"&&i(()=>{var u;return(u=o.dispose)==null?void 0:u.call(o)});const d=typeof o=="object"&&"promise"in o?await o.promise:await o;if(d)return d}if(s.validator){const a=s.validator(t,e);typeof a=="object"&&"dispose"in a&&typeof a.dispose=="function"&&i(()=>{var o;return(o=a.dispose)==null?void 0:o.call(a)});const l=typeof a=="object"&&"promise"in a?await a.promise:await a;if(l)return l}return""});class B{constructor(t,e){this.rules=n.ref([]),this.deps=null,this.validateDispose=null,this.debounce=0,this.transform=null,this.isEqual=null,this.focusFn=null,this.stopValidateWatcher=null,this.stopDirtyWatcher=null,this.isRegistered=!1,this.isInited=!1,this.runInAction=a=>{a()};const{immediate:i=!0}=e;this.form=t,this.name=e.name,this.setRules(e.rules||[]),this.deps=e.deps||null,this.transform=e.transform||null,this.isEqual=e.isEqual||null,this.focusFn=e.onFocus||null,this.debounce=e.debounce||0,this.initValue=e.initValue,this.initDefaultValue=e.initDefaultValue,this.state=n.reactive({error:null,isError:!1,isValidating:!1,isDirty:!1,isTouched:!1,isChanged:!1});const r=(a,l,o)=>{const d=this.transform;let u=!1;return R(async p=>{p(()=>{u=!0});for(const c of o){const g=z(c,d&&a!==void 0?d(a):a,l);p(()=>{var $;return($=g.dispose)==null?void 0:$.call(g)});const V=await g.promise;if(u)return null;let E=null;if(V)return E=typeof V=="string"?{type:c.type,message:V}:V,E.message=E.message.replace(/\{\{name\}\}/g,this.name),c.message!==void 0&&(E.message=c.message.replace(/\{\{name\}\}/g,this.name)),E}return null})};this.validate=r,i&&this.onRegister()}getValue(){return F(this.form.state.values,this.name)}getDefaultValue(){return F(this.form.state.defaultValues,this.name)}setRules(t=[]){this.rules.value=t.map(e=>e.debounce?{validator:C((r,a)=>z(e,r,a),e.debounce)}:e)}update(t={}){t.rules&&this.setRules(t.rules)}initWatcher(){if(this.isInited)return;const t=async i=>{var p;(p=this.validateDispose)==null||p.call(this),this.validateDispose=null;const{value:r,deps:a,rules:l}=i;let o=!1;const d=this.validate(r,a,l);this.validateDispose=()=>{var c;(c=d.dispose)==null||c.call(d),o=!0,this.validateDispose=null};const u=await d.promise;o||(this.runInAction(()=>{this.state.isValidating=!1;const c=!!(u!=null&&u.message);c?(this.state.error||(this.state.error={message:""}),this.state.error.message=(u==null?void 0:u.message)||"",this.state.error.type=u==null?void 0:u.type):this.state.error=null,this.state.isError=c}),this.validateDispose=null)},e=this.debounce?C(t,this.debounce):t;this.stopValidateWatcher=n.watchEffect(()=>{var l;this.runInAction(()=>{this.state.isValidating=!0});const i=this.getValue(),r=(l=this.deps)==null?void 0:l.call(this),a=this.rules.value;Promise.resolve().then(()=>{e({value:i,deps:r,rules:a})})}),this.stopDirtyWatcher=n.watchEffect(()=>{const i=this.getValue(),r=this.getDefaultValue();this.runInAction(()=>{const a=this.isEqual||((l,o)=>l===o);this.state.isDirty=!a(n.toRaw(i),n.toRaw(r))})}),this.isInited=!0}onRegister(){this.isRegistered||(this.initWatcher(),this.isRegistered=!0)}onUnregister(){var t,e,i;(t=this.validateDispose)==null||t.call(this),this.validateDispose=null,(e=this.stopValidateWatcher)==null||e.call(this),(i=this.stopDirtyWatcher)==null||i.call(this),this.isRegistered=!1,this.isInited=!1}onTouched(t=!0){this.runInAction(()=>{this.state.isTouched=t})}onChanged(t=!0){this.state.isChanged=t}onFocus(){var t;(t=this.focusFn)==null||t.call(this)}reset(t={}){var e,i,r;(e=this.validateDispose)==null||e.call(this),this.validateDispose=null,(i=this.stopValidateWatcher)==null||i.call(this),(r=this.stopDirtyWatcher)==null||r.call(this),this.runInAction(()=>{const{keepChanged:a=!1,keepTouched:l=!1}=t;this.state.error=null,this.state.isError=!1,this.state.isValidating=!1,this.state.isDirty=!1,this.state.isTouched=l?this.state.isTouched:!1,this.state.isChanged=a?this.state.isChanged:!1}),this.isInited=!1,this.initWatcher()}}const G=(s,t)=>R(async e=>{if(s.required&&!t&&t!==0||s.requiredLength&&(typeof(t==null?void 0:t.length)!="number"||t.length<=0))return"{{name}} is required";if(s.minLength!==void 0&&(typeof(t==null?void 0:t.length)!="number"||t.length<s.minLength))return`{{name}}'s length cannot be less than ${s.minLength}`;if(s.maxLength!==void 0&&(typeof(t==null?void 0:t.length)!="number"||t.length>s.maxLength))return`{{name}}'s length cannot be greater than ${s.maxLength}`;if(s.min!==void 0&&(typeof t!="number"||t<s.min))return`{{name}} cannot be less than ${s.min}`;if(s.max!==void 0&&(typeof t!="number"||t>s.max))return`{{name}} cannot be greater than ${s.max}`;if(s.pattern&&(typeof t!="string"&&typeof t!="number"||!s.pattern.test(`${t}`)))return`{{name}} not match ${s.pattern.toString()}`;const i=Object.keys(T);for(const r of i)if(s[r]===!0){const l=T[r](t);typeof l=="object"&&"dispose"in l&&typeof l.dispose=="function"&&e(()=>{var d;return(d=l.dispose)==null?void 0:d.call(l)});const o=typeof l=="object"&&"promise"in l?await l.promise:await l;if(o)return o}if(s.validator){const r=s.validator(t);typeof r=="object"&&"dispose"in r&&typeof r.dispose=="function"&&e(()=>{var l;return(l=r.dispose)==null?void 0:l.call(r)});const a=typeof r=="object"&&"promise"in r?await r.promise:await r;if(a)return a}return""});class H{constructor(t,e){this.name="",this.rules=n.ref([]),this.validateDispose=null,this.debounce=0,this.stopValidateWatcher=null,this.isRegistered=!1,this.isInited=!1,this.runInAction=a=>{a()};const{immediate:i=!0}=e;this.form=t,this.name=e.name,this.value=e.value,this.setRules(e.rules||[]),this.debounce=e.debounce||0,this.state=n.reactive({name:this.name,error:null,isError:!1,isValidating:!1});const r=(a,l)=>{let o=!1;return R(async d=>{d(()=>{o=!0});for(const u of l){const p=G(u,a);d(()=>{var V;return(V=p.dispose)==null?void 0:V.call(p)});const c=await p.promise;if(o)return null;let g=null;if(c)return g=typeof c=="string"?{type:u.type,message:c}:c,g.message=g.message.replace(/\{\{name\}\}/g,this.name),u.message!==void 0&&(g.message=u.message.replace(/\{\{name\}\}/g,this.name)),g}return null})};this.validate=r,i&&this.initWatcher()}setRules(t=[]){this.rules.value=t.map(e=>e.debounce?{validator:C(r=>G(e,r),e.debounce)}:e)}update(t){t.rules&&this.setRules(t.rules),t.value&&(this.value=t.value)}initWatcher(){var i;if(this.isInited)return;(i=this.validateDispose)==null||i.call(this),this.validateDispose=null;const t=async r=>{this.runInAction(()=>{this.state.isValidating=!0});const{value:a,rules:l}=r;let o=!1;const d=this.validate(a,l);this.validateDispose=()=>{var p;(p=d.dispose)==null||p.call(d),o=!0,this.validateDispose=null};const u=await d.promise;o||(this.runInAction(()=>{this.state.isValidating=!1;const p=!!(u!=null&&u.message);p?(this.state.error||(this.state.error={message:""}),this.state.error.message=(u==null?void 0:u.message)||"",this.state.error.type=u==null?void 0:u.type):this.state.error=null,this.state.isError=p}),this.validateDispose=null)},e=this.debounce?C(t,this.debounce):t;this.stopValidateWatcher=n.watchEffect(()=>{const r=this.value(),a=this.rules.value;Promise.resolve().then(()=>{e({value:r,rules:a})})}),this.isInited=!0}onRegister(){this.isRegistered||(this.initWatcher(),this.isRegistered=!0)}onUnregister(){var t,e;(t=this.validateDispose)==null||t.call(this),this.validateDispose=null,(e=this.stopValidateWatcher)==null||e.call(this),this.isRegistered=!1,this.isInited=!1}}class Z{constructor(t){this.touchType="BLUR",this._publicState=null,this.fieldsKeys=n.ref([]),this.fields=new Map,this.virtualFieldsKeys=n.ref([]),this.virtualFields=new Map,this.cacheFields=[],this.cacheVirtualFields=[],this.stopStateWatcher=null,this.stopStatusWatcher=null,this.stopValidatingWatcher=null,this.waiters=[],this.subscribers=[],this.isMounted=!1,this.readonly=!1,this.submitFlag=0,this.runInAction=i=>{i()};const{initValues:e={}}=t;this.initValues=n.toRaw(e),this.defaultValues=n.toRaw(t.defaultValues||t.initValues),this._state=n.reactive({values:e,defaultValues:t.defaultValues||e,fieldErrors:{},virtualErrors:{},error:null,fieldError:null,virtualError:null,isError:!1,isFieldError:!1,isVirtualError:!1,isValidating:!1,isFieldValidating:!1,isVirtualValidating:!1,isDirty:!1,isTouched:!1,isChanged:!1,isSubmitted:!1,isSubmitting:!1,submitCount:0}),this.touchType=t.touchType||"BLUR",this.readonly=t.readonly||!1}get state(){return this.readonly?(this._publicState||(this._publicState=n.readonly(this._state)),this._publicState):this._state}mount(){if(this.isMounted)return;const{cacheFields:t,cacheVirtualFields:e}=this;for(const i of t){const r=this.fields.get(i);r.initWatcher(),r.initDefaultValue!==void 0&&x(this._state.defaultValues,i,r.initDefaultValue),r.initValue!==void 0&&x(this._state.values,i,r.initValue)}for(const i of e){const r=this.virtualFields.get(i);r==null||r.initWatcher()}this.cacheFields=[],this.cacheVirtualFields=[],this.fieldsKeys.value.push(...t),this.virtualFieldsKeys.value.push(...e),this.stopStateWatcher=n.watchEffect(()=>{const i=this.fieldsKeys.value,r=this.virtualFieldsKeys.value;let a=!1,l=!1,o=!1,d=!1,u=!1,p=!1,c=!1,g=null,V=null;const E={},$={};i.forEach(I=>{const w=this.fields.get(I);if(!w)return;const m=w.state.error,h=w.state.isError,y=w.state.isValidating,b=w.state.isDirty,_=w.state.isTouched,S=w.state.isChanged;x(E,I,m),h&&(a=!0),y&&(o=!0),b&&(u=!0),_&&(p=!0),S&&(c=!0),m&&!g&&(g=m)}),r.forEach(I=>{const w=this.virtualFields.get(I);if(!w)return;const m=w.state.error,h=w.state.isError,y=w.state.isValidating;x($,I,m),h&&(l=!0),y&&(d=!0),m&&!V&&(V=m)}),this.runInAction(()=>{M(this._state.fieldErrors,E),M(this._state.virtualErrors,$),this._state.isFieldError=a,this._state.isVirtualError=l,this._state.isError=a||l,this._state.fieldError=g,this._state.virtualError=V,this._state.error=g||V,this._state.isFieldValidating=o,this._state.isVirtualValidating=d,this._state.isValidating=o||d,this._state.isDirty=u,this._state.isTouched=p,this._state.isChanged=c})}),this.stopValidatingWatcher=n.watchEffect(()=>{this._state.isValidating||this.waiters.forEach(r=>{r()}),this.waiters=[]}),this.isMounted=!0}unmount(){var i,r,a;(i=this.stopStateWatcher)==null||i.call(this),(r=this.stopStatusWatcher)==null||r.call(this),(a=this.stopValidatingWatcher)==null||a.call(this);const t=[...this.fieldsKeys.value];for(const l of t)this.unregisterField(l);const e=[...this.virtualFieldsKeys.value];for(const l of e)this.unregisterVirtualField(l);for(const l of this.cacheFields)this.unregisterField(l);for(const l of this.cacheVirtualFields)this.unregisterVirtualField(l);this.subscribers=[],this.reset({values:n.toRaw(this.initValues),defaultValues:n.toRaw(this.defaultValues)}),this.isMounted=!1}registerField(t,e={}){const{immediate:i=!0,value:r=F(this.initValues,t),defaultValue:a=F(this.defaultValues||{},t)}=e,{fieldsKeys:l,fields:o,cacheFields:d}=this;if(l.value.includes(t)||d.includes(t))return console.warn(`Duplicate field <${t}>.`),{field:this.fields.get(t),register:()=>{}};for(const c of[...l.value,...d])if(c.startsWith(`${t}.`)||t.startsWith(`${c}.`))return console.warn(`Fields can not be nested together: <${t}> <${c}>. If you want do this, please use [registerVirtualField]`),{field:this.fields.get(t),register:()=>{}};const u=new B(this,N(U({},e),{name:t,initValue:r,initDefaultValue:a}));o.set(t,u);const p=()=>{this.runInAction(()=>{this.isMounted?(a!==void 0&&x(this._state.defaultValues,t,a),r!==void 0&&x(this._state.values,t,a),this.fieldsKeys.value.push(t),u.initWatcher()):this.cacheFields.push(t)})};return i?(p(),{field:u,register:()=>{}}):{register:p,field:u}}registerVirtualField(t,e){const{immediate:i=!0}=e,{virtualFieldsKeys:r,virtualFields:a,cacheVirtualFields:l}=this;if(r.value.includes(t)||l.includes(t))return console.warn(`Duplicate virtual field <${t}>.`),{field:this.virtualFields.get(t),register:()=>{}};const o=new H(this,N(U({},e),{name:t}));a.set(t,o);const d=()=>{this.runInAction(()=>{this.isMounted?(this.virtualFieldsKeys.value.push(t),o.initWatcher()):this.cacheVirtualFields.push(t)})};return i?(d(),{field:o,register:()=>{}}):{register:d,field:o}}unregisterField(t,e={}){const{removeValue:i=!1}=e,{fields:r}=this,a=r.get(t);if(!!a){if(a.onUnregister(),this.isMounted){const l=this.fieldsKeys.value.indexOf(t);l!==-1&&this.fieldsKeys.value.splice(l,1)}else{const l=this.cacheFields.indexOf(t);l!==-1&&this.cacheFields.splice(l,1)}this.runInAction(()=>{i&&D(this._state.values,t),i&&D(this._state.defaultValues,t),D(this._state.fieldErrors,t)}),r.delete(t)}}unregisterVirtualField(t){const{virtualFields:e}=this,i=e.get(t);if(!!i){if(i.onUnregister(),this.isMounted){const r=this.virtualFieldsKeys.value.indexOf(t);r!==-1&&this.virtualFieldsKeys.value.splice(r,1)}else{const r=this.cacheVirtualFields.indexOf(t);r!==-1&&this.cacheVirtualFields.splice(r,1)}this.runInAction(()=>{D(this._state.virtualErrors,t)}),e.delete(t)}}setPathValue(t,e){x(this._state.values,t,e),this.notify("UPDATE",t)}setValue(t,e){const i=this.fields.get(t);if(!i){console.warn(`Field not exists <${t}>.`);return}const a=n.toRaw(F(this._state.values,t))!==n.toRaw(e);this.setPathValue(t,e),i.onChanged(i.state.isChanged||a)}deletePathValue(t){D(this._state.values,t),this.notify("DELETE",t)}deleteValue(t){if(!this.fields.get(t)){console.warn(`Field not exists <${t}>.`);return}this.deletePathValue(t)}getPathValueRef(t){return n.computed(()=>F(this.state.values,t))}getValueRef(t){return n.computed(()=>{if(!this.fieldsKeys.value.includes(t)){console.warn(`Field not exists <${t}>.`);return}return F(this.state.values,t)})}getPathValue(t){return F(this.state.values,t)}getValue(t){if(!this.fieldsKeys.value.includes(t)){console.warn(`Field not exists <${t}>.`);return}return F(this.state.values,t)}setTouched(t,e=!0){const i=this.fields.get(t);if(!i){console.warn(`Field not exists <${t}>.`);return}i.onTouched(e)}setFocus(t){const e=this.fields.get(t);if(!e){console.warn(`Field not exists <${t}>.`);return}e.onFocus()}submit(t={}){const e=this.submitFlag,i=()=>{var r,a;if(e===this.submitFlag){if(this.runInAction(()=>{this._state.isSubmitting=!1}),this._state.isError){(r=t.onError)==null||r.call(t,n.toRaw(this._state.error));return}this.runInAction(()=>{this._state.isSubmitted=!0}),(a=t.onSuccess)==null||a.call(t,n.toRaw(this._state.values))}};this.runInAction(()=>{this._state.submitCount++,this._state.isSubmitting=!0}),this._state.isValidating?this.waiters.push(()=>{i()}):i()}reset(t={}){this.waiters=[],this.runInAction(()=>{t.values?(this._state.values=n.toRaw(t.values),this.initValues=n.toRaw(t.values)):t.keepValues||(this._state.values=this.initValues),t.defaultValues?(this._state.defaultValues=n.toRaw(t.defaultValues),this.defaultValues=t.defaultValues):t.keepDefaultValues||(this._state.defaultValues=this.initValues||this.defaultValues),this.submitFlag++,this._state.isSubmitting=!1,this._state.submitCount=t.keepSubmitCount?this._state.submitCount:0,this._state.isSubmitted=t.keepIsSubmitted?this._state.isSubmitted:!1});for(const[,e]of this.fields)e.reset({keepTouched:t.keepTouched,keepChanged:t.keepChanged});this.notify("RESET")}resetField(t,e={}){const i=this.fields.get(t);if(!i){console.warn(`Field not exists <${t}>.`);return}if("defaultValue"in e&&x(this._state.defaultValues,t,n.toRaw(e.defaultValue)),"value"in e)x(this._state.values,t,n.toRaw(e.value));else if(!e.keepValue){const r=F(this._state.defaultValues,t);x(this._state.values,t,n.toRaw(r))}i.reset({keepTouched:e.keepTouched,keepChanged:e.keepChanged})}subscribe(t){return this.subscribers.push(t),()=>{const i=this.subscribers.indexOf(t);i!==-1&&this.subscribers.splice(i,1)}}notify(t,e){this.subscribers.forEach(i=>{i(t,e)})}fieldState(t){if(!this.fieldsKeys.value.includes(t))return null;const e=this.fields.get(t);return e?e.state:null}virtualFieldState(t){if(!this.virtualFieldsKeys.value.includes(t))return null;const e=this.virtualFields.get(t);return e?e.state:null}isDirty(t){var e;return((e=this.fieldState(t))==null?void 0:e.isDirty)||!1}isTouched(t){var e;return((e=this.fieldState(t))==null?void 0:e.isTouched)||!1}isChanged(t){var e;return((e=this.fieldState(t))==null?void 0:e.isChanged)||!1}isValidating(t){var e;return((e=this.fieldState(t))==null?void 0:e.isValidating)||!1}isVirtualValidating(t){var e;return((e=this.virtualFieldState(t))==null?void 0:e.isValidating)||!1}isError(t){var e;return((e=this.fieldState(t))==null?void 0:e.isError)||!1}isVirtualError(t){var e;return((e=this.virtualFieldState(t))==null?void 0:e.isError)||!1}fieldError(t){var e;return((e=this.fieldState(t))==null?void 0:e.error)||null}virtualFieldError(t){var e;return((e=this.virtualFieldState(t))==null?void 0:e.error)||null}arrayAppend(t,e){const i=F(this._state.values,t);!Array.isArray(i)||(i.push(e),this.notify("UPDATE",t))}arrayPrepend(t,e){const i=F(this._state.values,t);!Array.isArray(i)||(i.unshift(e),this.notify("UPDATE",t))}arrayInsert(t,e,i){const r=F(this._state.values,t);!Array.isArray(r)||(r.splice(e,0,i),this.notify("UPDATE",t))}arraySwap(t,e,i){const r=F(this._state.values,t);if(!Array.isArray(r))return;const a=r[i];r[i]=r[e],r[e]=a,this.notify("UPDATE",t)}arrayMove(t,e,i){const r=F(this._state.values,t);!Array.isArray(r)||(r.splice(i,0,r[e]),r.splice(i>e?e:e+1),this.notify("UPDATE",t))}arrayUpdate(t,e,i){const r=F(this._state.values,t);!Array.isArray(r)||(r.splice(e,1,i),this.notify("UPDATE",t))}arrayRemove(t,e){const i=F(this._state.values,t);!Array.isArray(i)||(i.splice(e,1),this.notify("UPDATE",t))}arrayReplace(t,e){const i=F(this._state.values,t);!Array.isArray(i)||(x(this._state.values,t,e),this.notify("UPDATE",t))}}const ct=s=>new Z(s),L=Symbol(),P=()=>n.inject(L,null),J=s=>{const t=P(),{form:e=t,name:i}=s;if(!e)throw new Error("No provided form!");const r=n.computed(()=>s.touchType?n.unref(s.touchType):e.touchType||"BLUR"),a=n.ref(!1),l=n.ref(null),o=h=>l.value=h,d=h=>{var b,_;const y=typeof h=="object"&&typeof h.currentTarget=="object"&&((b=h.currentTarget)==null?void 0:b.value)!==void 0?(_=h.currentTarget)==null?void 0:_.value:h;e.setValue(n.unref(i),y)},u=()=>{r.value==="BLUR"&&e.setTouched(n.unref(i),!0)},p=()=>{r.value==="FOCUS"&&e.setTouched(n.unref(i),!0)};let{register:c,field:g}=e.registerField(n.unref(i),{rules:n.unref(s.rules),transform:s.transform,deps:s.deps,immediate:!1,onFocus:()=>{var h,y;(y=(h=l.value)==null?void 0:h.focus)==null||y.call(h)},debounce:s.debounce,value:s.value,defaultValue:s.defaultValue});const V=n.ref(F(e.state.values,n.unref(s.name))),E=n.ref(g.state),$=n.watch(()=>[n.unref(s.name),n.unref(s.rules)],([h,y],[b])=>{e.unregisterField(b);const _=e.registerField(h,{rules:y,transform:s.transform,deps:s.deps,isEqual:s.isEqual,immediate:a.value,onFocus:()=>{var S,W;(W=(S=l.value)==null?void 0:S.focus)==null||W.call(S)},debounce:s.debounce,value:s.value,defaultValue:s.defaultValue});c=_.register,g=_.field,E.value=_.field.state,V.value=F(e.state.values,n.unref(s.name))}),I=n.watch(()=>F(e.state.values,n.unref(s.name)),h=>{V.value=h}),w=n.watch(()=>V.value,h=>{const y=F(e.state.values,n.unref(s.name));n.toRaw(y)!==n.toRaw(h)&&(V.value=h)});return n.onMounted(()=>{c==null||c(),a.value=!0}),n.onBeforeUnmount(()=>{e.unregisterField(n.unref(i)),$(),I(),w(),l.value=null}),[s.changeType==="ONCHANGE"?n.reactive({get value(){return V.value},onChange:d,onBlur:u,onFocus:p,ref:o}):n.reactive({get value(){return V.value},onInput:d,onBlur:u,onFocus:p,ref:o}),V,{mounted:a}]},Q=s=>{const t=P(),{form:e=t,name:i}=s;if(!e)throw new Error("No provided form!");const r=n.ref(!1);let{register:a,field:l}=e.registerVirtualField(n.unref(i),{value:s.value,rules:n.unref(s.rules),immediate:!1,debounce:s.debounce});const o=n.ref(l.state),d=n.watch(()=>n.unref(s.name),(u,p)=>{e.unregisterVirtualField(p);const c=e.registerVirtualField(n.unref(i),{value:s.value,rules:n.unref(s.rules),immediate:r.value,debounce:s.debounce});a=c.register,l=c.field,o.value=c.field.state});return n.onMounted(()=>{a(),r.value=!0}),n.onBeforeUnmount(()=>{e.unregisterVirtualField(n.unref(i)),d()}),{mounted:r}},X=(s,t)=>{let e=0,i=s.getPathValue(t);Array.isArray(i)||(s.setPathValue(t,[]),i=s.getPathValue(t));const a=i.map(m=>({id:`${e++}`,name:`${t}.${m}`}));let l=a.map(m=>m.id);const o=n.ref(a),d={},u=n.watch(()=>s.getPathValue(t).map(h=>n.toRaw(h)),(m,h)=>{const y=[...h],b=m.map((_,S)=>{const W=n.toRaw(_),j=y.findIndex(bt=>n.toRaw(bt)===W);let k="";return j===-1?k=`${e++}`:(k=l[j],y[j]=d),{id:`${k}`,name:`${t}.${S}`}});o.value=b,l=b.map(_=>_.id)});return{onCleanup:()=>{u()},get fieldsValue(){return o.value},fields:o,prepend:m=>{s.arrayPrepend(t,m)},append:m=>{s.arrayAppend(t,m)},insert:(m,h)=>{const y=o.value.findIndex(b=>b.id===m);y!==-1&&s.arrayInsert(t,y,h)},swap:(m,h)=>{const y=o.value.findIndex(_=>_.id===m),b=o.value.findIndex(_=>_.id===h);y===-1||b===-1||s.arraySwap(t,y,b)},move:(m,h)=>{const y=o.value.findIndex(_=>_.id===m),b=o.value.findIndex(_=>_.id===h);y===-1||b===-1||y===b||s.arrayMove(t,y,b)},replace:m=>{l=[],s.arrayReplace(t,m)},remove:m=>{const h=o.value.findIndex(y=>y.id===m);h!==-1&&s.arrayRemove(t,h)},update:(m,h)=>{const y=o.value.findIndex(b=>b.id===m);y!==-1&&s.arrayUpdate(t,y,h)}}},Y=s=>{const t=P(),{form:e=t,path:i}=s;if(!e)throw new Error("No provided form!");const l=X(e,i),{onCleanup:r}=l,a=q(l,["onCleanup"]);return n.onBeforeUnmount(()=>r()),a},ft=n.defineComponent({__name:"VirtualField",props:{form:{type:Object,default:void 0},name:{type:String,required:!0},value:{type:Function,required:!0},rules:{type:Array,default:()=>[]},debounce:{type:Number,default:void 0}},setup(s){const t=s,{name:e,form:i,value:r,rules:a,debounce:l}=n.toRefs(t),{mounted:o}=Q({form:i==null?void 0:i.value,rules:a.value,value:r.value,debounce:l==null?void 0:l.value,name:e});return(d,u)=>n.unref(o)?n.renderSlot(d.$slots,"default",{key:0}):n.createCommentVNode("",!0)}}),ht=n.defineComponent({__name:"FieldArray",props:{form:{type:Object,default:void 0},name:{type:String,required:!0}},setup(s){const t=s,a=Y({form:t.form,path:t.name}),{fieldsValue:e,fields:i}=a,r=q(a,["fieldsValue","fields"]);return(l,o)=>n.renderSlot(l.$slots,"default",n.mergeProps(r,{fields:n.unref(i)}))}}),pt=n.defineComponent({__name:"FormProvider",props:{form:{type:Object,required:!0}},setup(s){const t=s;return n.provide(L,t.form),n.onMounted(()=>t.form.mount()),n.onUnmounted(()=>t.form.unmount()),(e,i)=>n.renderSlot(e.$slots,"default")}}),mt=()=>({form:{type:Object,default:void 0},name:{type:String,required:!0},rules:{type:Array,default:()=>[]},deps:{type:Function,default:void 0},debounce:{type:Number,default:void 0},value:{type:O,default:void 0},defaultValue:{type:O,default:void 0},transform:{type:Function,default:void 0},touchType:{type:String,default:"BLUR"},changeType:{type:String,default:"ONCHANGE"},isEqual:{type:Function,default:void 0}}),yt=n.defineComponent({__name:"index",props:mt(),setup(s){const t=s,$=n.toRefs(t),{form:e,rules:i,transform:r,name:a,deps:l,debounce:o,changeType:d,value:u,defaultValue:p,isEqual:c}=$,g=q($,["form","rules","transform","name","deps","debounce","changeType","value","defaultValue","isEqual"]),[V,,{mounted:E}]=J(U({form:e==null?void 0:e.value,rules:i.value,transform:r==null?void 0:r.value,deps:l==null?void 0:l.value,debounce:o==null?void 0:o.value,name:a,changeType:d.value,value:u==null?void 0:u.value,defaultValue:p==null?void 0:p.value,isEqual:c==null?void 0:c.value},g));return(I,w)=>n.unref(E)?n.renderSlot(I.$slots,"default",{key:0,field:n.unref(V)}):n.createCommentVNode("",!0)}}),gt=ft,Vt=ht,Ft=pt;f.Field=yt,f.FieldArray=Vt,f.FieldClass=B,f.Form=Z,f.FormContextKey=L,f.FormProvider=Ft,f.VirtualField=gt,f.VirtualFieldClass=H,f.createFieldArray=X,f.createForm=ct,f.useField=J,f.useFieldArray=Y,f.useForm=P,f.useVirtualField=Q,f.validators=T,Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
