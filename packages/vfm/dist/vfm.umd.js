(function(c,a){typeof exports=="object"&&typeof module!="undefined"?a(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],a):(c=typeof globalThis!="undefined"?globalThis:c||self,a(c.VFM={},c.Vue))})(this,function(c,a){"use strict";var ot=Object.defineProperty,lt=Object.defineProperties;var ct=Object.getOwnPropertyDescriptors;var z=Object.getOwnPropertySymbols;var ut=Object.prototype.hasOwnProperty,ht=Object.prototype.propertyIsEnumerable;var U=(c,a,F)=>a in c?ot(c,a,{enumerable:!0,configurable:!0,writable:!0,value:F}):c[a]=F,T=(c,a)=>{for(var F in a||(a={}))ut.call(a,F)&&U(c,F,a[F]);if(z)for(var F of z(a))ht.call(a,F)&&U(c,F,a[F]);return c},R=(c,a)=>lt(c,ct(a));const F=s=>{const t="{{name}} is not alphabetical";return typeof s!="string"?t:/^[a-zA-Z]*$/.test(s)?"":t},O=s=>{const t="{{name}} must be alpha-numeric";return typeof s!="string"&&typeof s!="number"?t:/^[a-zA-Z0-9]*$/.test(`${s}`)?"":t},N=s=>{const t="{{name}} must be decimal";return typeof s!="string"&&typeof s!="number"?t:/^[-]?\d*(\.\d+)?$/.test(`${s}`)?"":t},q=/^(?:[A-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[A-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9]{2,}(?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])$/i,B=s=>{const t="{{name}} is not a valid email address";return typeof s!="string"?t:q.test(s)?"":t},P=s=>{const t="{{name}} is not an integer";return typeof s!="string"&&typeof s!="number"?t:/(^[0-9]*$)|(^-[0-9]+$)/.test(`${s}`)?"":t},Z=s=>{const t="{{name}} is not a valid IP address";if(typeof s!="string")return t;const e=s.split(".");return e.length===4&&e.every(G)?"":t},G=s=>{if(s.length>3||s.length===0||s[0]==="0"&&s!=="0"||!s.match(/^\d+$/))return!1;const t=+s;return t>=0&&t<=255},H=s=>{const t="{{name}} is not a valid MAC Address";if(typeof s!="string")return t;const e=":",i=s.split(e);return(i.length===6||i.length===8)&&i.every(J)?"":t},J=s=>s.toLowerCase().match(/^[0-9a-f]{2}$/),I={alpha:F,alphaNum:O,decimal:N,email:B,integer:P,ipAddress:Z,macAddress:H,numeric:s=>{const t="{{name}} must be numeric";return typeof s!="string"&&typeof s!="number"?t:/^-?\d*(\.\d+)?$/.test(`${s}`)?"":t}},C=(s,t,e)=>{const i=t.split(".");let r=s;for(;i.length&&typeof r=="object"&&r!==null;){const n=i.shift();i.length===0?r[n]=e:(typeof r[n]!="object"||r[n]===null)&&(r[n]=/^\d+$/.test(n)?[]:{}),r=r[n]}},W=(s,t)=>{const e=t.split(".");let i=s;for(;e.length&&i;){const r=e.shift();i=typeof i=="object"&&i!==null?i[r]:void 0}return i},b=(s,t)=>{const e=t.split(".");let i=s;for(;e.length&&typeof i=="object"&&i!==null;){const r=e.shift();e.length===0?Array.isArray(i)?/^\d+$/.test(r)&&i.splice(Number(r),1):delete i[r]:i=i[r]}},x=(s,t)=>{const e=Object.keys(s),i=Object.keys(t);e.filter(n=>!i.includes(n)).forEach(n=>{delete s[n]}),i.forEach(n=>{typeof s[n]=="object"&&!Array.isArray(s[n])&&s[n]!==null&&typeof t[n]=="object"&&!Array.isArray(t[n])&&t[n]!==null?x(s[n],t[n]):s[n]=t[n]})},E=s=>{const t=[];let e=null;const i=s(n=>{t.push(n)}),r=new Promise((n,o)=>{e=n,i.then(n,o)});return r.cancel=()=>{e==null||e(""),t.forEach(n=>n())},r},Q=(s,t,e)=>E(async i=>{if(s.required&&!t||s.requiredLength&&(typeof(t==null?void 0:t.length)!="number"||t.length<=0))return"{{name}} is required";if(s.minLength!==void 0&&(typeof(t==null?void 0:t.length)!="number"||t.length<s.minLength))return`{{name}}'s length cannot be less than ${s.minLength}`;if(s.maxLength!==void 0&&(typeof(t==null?void 0:t.length)!="number"||t.length>s.maxLength))return`{{name}}'s length cannot be greater than ${s.maxLength}`;if(s.min!==void 0&&(typeof t!="number"||t<s.min))return`{{name}} cannot be less than ${s.min}`;if(s.max!==void 0&&(typeof t!="number"||t>s.max))return`{{name}} cannot be greater than ${s.max}`;if(s.pattern&&(typeof t!="string"&&typeof t!="number"||!s.pattern.test(`${t}`)))return`{{name}} not match ${s.pattern.toString()}`;for(const r of Object.keys(I))if(s[r]===!0){const o=I[r](t,e);typeof o=="object"&&typeof o.cancel=="function"&&i(()=>{var u;return(u=o.cancel)==null?void 0:u.call(o)});const l=await o;if(l)return l}if(s.validator){const r=s.validator(t,e);typeof r=="object"&&typeof r.cancel=="function"&&i(()=>{var o;return(o=r.cancel)==null?void 0:o.call(r)});const n=await r;if(n)return n}return""});class j{constructor(t,e){this.validateCount=0,this.transform=null,this.focusFn=null,this.stopValidateWatcher=null,this.stopDirtyWatcher=null,this.isRegistered=!1,this.runInAction=l=>{l()};const{immediate:i=!0,rules:r=[],transform:n=null}=e;this.form=t,this.name=e.name,this.state=a.reactive({name:this.name,value:e.value===void 0?e.defaultValue:e.value,defaultValue:e.defaultValue,error:null,isError:!1,isValidating:!1,isDirty:!1,isTouched:!1,isChanged:!1}),this.transform=n,this.focusFn=e.onFocus||null;const o=(l,u)=>E(async g=>{const h=this.transform;for(const m of r){const y=Q(m,h&&l!==void 0?h(l):l,u);g(()=>{var f;return(f=y.cancel)==null?void 0:f.call(y)});const V=await y;let v=null;if(V)return v=typeof V=="string"?{type:m.type,message:V}:V,v.message=v.message.replace(/\{\{name\}\}/g,this.name),v}return null});this.validate=o,i&&this.onRegister()}initWatcher(){this.stopValidateWatcher=a.watchEffect(async t=>{this.validateCount++;const e=this.state.value,i=this.form.state,r=this.validateCount,n=this.validate;this.runInAction(()=>{this.state.isValidating=!0});const o=n(e,i);t(()=>{var u;return(u=o.cancel)==null?void 0:u.call(o)});const l=await o;r===this.validateCount&&this.runInAction(()=>{this.state.isValidating=!1;const u=!!(l!=null&&l.message);u?(this.state.error||(this.state.error={message:""}),this.state.error.message=(l==null?void 0:l.message)||"",this.state.error.type=l==null?void 0:l.type):this.state.error=null,this.state.isError=u})}),this.stopDirtyWatcher=a.watchEffect(()=>{const{value:t,defaultValue:e}=this.state;this.runInAction(()=>{this.state.isDirty=t!==e})})}onRegister(){this.isRegistered||(this.initWatcher(),this.isRegistered=!0)}onUnregister(){var t,e;(t=this.stopValidateWatcher)==null||t.call(this),(e=this.stopDirtyWatcher)==null||e.call(this),this.isRegistered=!1}onChange(t){if(t===void 0)return;const e=this.state.value!==t;this.runInAction(()=>{this.state.value=t,this.state.isChanged=this.state.isChanged||e})}onTouched(t=!0){this.runInAction(()=>{this.state.isTouched=t})}onFocus(){var t;(t=this.focusFn)==null||t.call(this)}reset(t){var e,i;this.validateCount++,(e=this.stopValidateWatcher)==null||e.call(this),(i=this.stopDirtyWatcher)==null||i.call(this),this.runInAction(()=>{t!==void 0&&(this.state.defaultValue=t),this.state.error=null,this.state.isError=!1,this.state.isValidating=!1,this.state.isDirty=!1,this.state.isTouched=!1,this.state.isChanged=!1,this.state.value=this.state.defaultValue}),this.initWatcher()}}const X=(s,t)=>E(async e=>{if(s.validator){const i=s.validator(t);typeof i=="object"&&typeof i.cancel=="function"&&e(()=>{var n;return(n=i.cancel)==null?void 0:n.call(i)});const r=await i;if(r)return r}return""});class M{constructor(t,e){this.name="",this.validateCount=0,this.stopValidateWatcher=null,this.isRegistered=!1,this.runInAction=o=>{o()};const{immediate:i=!0,rules:r=[]}=e;this.form=t,this.name=e.name,this.state=a.reactive({name:this.name,error:null,isError:!1,isValidating:!1});const n=o=>E(async l=>{let u=null;for(const g of r){const h=X(g,o);l(()=>{var y;return(y=h.cancel)==null?void 0:y.call(h)});const m=await h;if(m)return u=typeof m=="string"?{type:g.type,message:m}:m,u.message=u.message.replace(/\{\{name\}\}/g,this.name),u}return null});this.validate=n,i&&this.initWatcher()}initWatcher(){this.stopValidateWatcher=a.watchEffect(async t=>{this.validateCount++;const e=this.form.state,i=this.validateCount;this.runInAction(()=>{this.state.isValidating=!0});const r=this.validate(e);t(()=>{var o;return(o=r.cancel)==null?void 0:o.call(r)});const n=await r;i===this.validateCount&&this.runInAction(()=>{this.state.isValidating=!1;const o=!!(n!=null&&n.message);o?(this.state.error||(this.state.error={message:""}),this.state.error.message=(n==null?void 0:n.message)||"",this.state.error.type=n==null?void 0:n.type):this.state.error=null,this.state.isError=o})})}onRegister(){this.isRegistered||(this.initWatcher(),this.isRegistered=!0)}onUnregister(){var t;(t=this.stopValidateWatcher)==null||t.call(this)}}class D{constructor(t){this.fieldStates=a.reactive({}),this.virtualFieldStates=a.reactive({}),this.touchType="BLUR",this.cacheFields=[],this.cacheVirtualFields=[],this.isMounted=!1,this.fieldsKeys=a.ref([]),this.fields=new Map,this.virtualFieldsKeys=a.ref([]),this.virtualFields=new Map,this.stopStateWatcher=null,this.stopStatusWatcher=null,this.stopValidatingWatcher=null,this.waiters=[],this.defaultValues={},this.runInAction=e=>{e()},this.defaultValues=a.toRaw(t.defaultValues||{}),this.state=a.reactive({values:a.toRaw(this.defaultValues)||{},errors:{},virtualErrors:{},error:null,isError:!1,isValidating:!1,isDirty:!1,isTouched:!1,isChanged:!1,isSubmitted:!1,isSubmitting:!1,submitCount:0}),this.touchType=t.touchType||"BLUR"}mount(){if(this.isMounted)return;const{cacheFields:t,cacheVirtualFields:e}=this;this.fieldsKeys.value.push(...t),this.virtualFieldsKeys.value.push(...e),this.cacheFields=[],this.cacheVirtualFields=[],this.stopStateWatcher=a.watchEffect(()=>{const i=this.fieldsKeys.value,r=this.virtualFieldsKeys.value;let n=!1,o=!1,l=!1,u=!1,g=!1,h=null;const m={},y={},V={},v={},f={};i.forEach(p=>{const d=this.fields.get(p);if(!d)return;const $=d.state,w=d.state.value,A=d.state.error,K=d.state.isError,it=d.state.isValidating,rt=d.state.isDirty,nt=d.state.isTouched,at=d.state.isChanged;C(m,p,w),C(y,p,A),C(V,p,$),K&&(n=!0),it&&(o=!0),rt&&(l=!0),nt&&(u=!0),at||(g=!0),A&&!h&&(h=A)}),r.forEach(p=>{const d=this.virtualFields.get(p);if(!d)return;const $=d.state,w=d.state.error,A=d.state.isError,K=d.state.isValidating;C(v,p,w),C(f,p,$),A&&(n=!0),K&&(o=!0),w&&!h&&(h=w)}),this.runInAction(()=>{x(this.state.values,m),x(this.state.errors,y),x(this.state.virtualErrors,v),x(this.fieldStates,V),x(this.virtualFieldStates,f),this.state.isError=n,this.state.error=h,this.state.isValidating=o,this.state.isDirty=l,this.state.isTouched=u,this.state.isChanged=g})}),this.stopValidatingWatcher=a.watchEffect(()=>{this.state.isValidating||this.waiters.forEach(r=>{r()}),this.waiters=[]}),this.isMounted=!0}unmount(){var t,e,i;(t=this.stopStateWatcher)==null||t.call(this),(e=this.stopStatusWatcher)==null||e.call(this),(i=this.stopValidatingWatcher)==null||i.call(this);for(const r of this.fieldsKeys.value)this.unregisterField(r);for(const r of this.virtualFieldsKeys.value)this.unregisterVirtualField(r);for(const r of this.cacheFields)this.unregisterField(r);for(const r of this.cacheVirtualFields)this.unregisterVirtualField(r);this.isMounted=!1}registerField(t,e={}){const{immediate:i=!0}=e,{fieldsKeys:r,fields:n}=this;if(r.value.includes(t))return console.warn(`Duplicate field <${t}>.`),{field:this.fields.get(t),register:()=>{}};for(const m of r.value)if(m.startsWith(`${t}.`)||t.startsWith(`${m}.`))return console.warn(`Fields can not be nested together: <${t}> <${m}>.`),{field:this.fields.get(t),register:()=>{}};const o=W(this.state.values,t);let l=e.value;l===void 0&&(l=o),l===void 0&&(l=e.defaultValue);const u=o===void 0?e.defaultValue:o,g=new j(this,R(T({},e),{name:t,value:l,defaultValue:u})),h=()=>{n.set(t,g),this.runInAction(()=>{this.isMounted?this.fieldsKeys.value.push(t):this.cacheFields.push(t)}),g.initWatcher()};return i?(h(),{field:g,register:()=>{}}):{register:h,field:g}}registerVirtualField(t,e={}){const{immediate:i=!0}=e,{virtualFieldsKeys:r,virtualFields:n}=this;if(r.value.includes(t))return console.warn(`Duplicate virtual field <${t}>.`),{field:this.virtualFields.get(t),register:()=>{}};const o=new M(this,R(T({},e),{name:t})),l=()=>{n.set(t,o),this.runInAction(()=>{this.isMounted?this.virtualFieldsKeys.value.push(t):this.cacheVirtualFields.push(t)}),o.initWatcher()};return i?(l(),{field:o,register:()=>{}}):{register:l,field:o}}unregisterField(t){const{fields:e}=this,i=e.get(t);if(!!i){if(i.onUnregister(),this.isMounted){const r=this.fieldsKeys.value.indexOf(t);r!==-1&&this.fieldsKeys.value.splice(r,1)}else{const r=this.cacheFields.indexOf(t);r!==-1&&this.cacheFields.splice(r,1)}this.runInAction(()=>{b(this.state.values,t),b(this.state.errors,t),b(this.fieldStates,t)}),e.delete(t)}}unregisterVirtualField(t){const{virtualFields:e}=this,i=e.get(t);if(!!i){if(i.onUnregister(),this.isMounted){const r=this.virtualFieldsKeys.value.indexOf(t);r!==-1&&this.virtualFieldsKeys.value.splice(r,1)}else{const r=this.cacheVirtualFields.indexOf(t);r!==-1&&this.cacheVirtualFields.splice(r,1)}this.runInAction(()=>{b(this.state.virtualErrors,t),b(this.virtualFieldStates,t)}),e.delete(t)}}setValue(t,e){if(e===void 0)return;const i=this.fields.get(t);if(!i){console.warn(`Field not exists <${t}>.`);return}i.onChange(e)}deleteValue(t){if(!this.fields.get(t)){console.warn(`Field not exists <${t}>.`);return}b(this.state.values,t)}getValue(t){return a.computed(()=>W(this.state.values,t))}setTouched(t,e=!0){const i=this.fields.get(t);if(!i){console.warn(`Field not exists <${t}>.`);return}i.onTouched(e)}setFocus(t){const e=this.fields.get(t);if(!e){console.warn(`Field not exists <${t}>.`);return}e.onFocus()}submit(t,e){const i=()=>{if(this.runInAction(()=>{this.state.isSubmitting=!1}),this.state.isError){e(a.toRaw(this.state.errors));return}this.runInAction(()=>{this.state.isSubmitted=!0}),t(a.toRaw(this.state.values))};this.runInAction(()=>{this.state.submitCount++,this.state.isSubmitting=!0}),this.state.isValidating?this.waiters.push(()=>{i()}):i()}reset(t){this.waiters=[],this.runInAction(()=>{this.state.values=t===void 0?this.defaultValues:t,this.state.errors={},this.state.virtualErrors={},this.state.error=null,this.state.isError=!1,this.state.isValidating=!1,this.state.isDirty=!1,this.state.isTouched=!1,this.state.isChanged=!1,this.state.isSubmitted=!1,this.state.isSubmitting=!1,this.state.submitCount=0});for(const[e,i]of this.fields){const r=W(this.state.values,e);i.reset(r)}}}const Y=s=>new D(s),S=Symbol(),_=s=>{const t=a.inject(S,null),{form:e=t,name:i}=s,{touchType:r=e==null?void 0:e.touchType}=s,n=a.ref(!1);if(!e)throw new Error(`No form in the injected context or props, can not use Field <${s.name}>`);const o=a.ref(null),l=f=>o.value=f,u=f=>{var d,$;const p=typeof f=="object"&&typeof f.currentTarget=="object"&&((d=f.currentTarget)==null?void 0:d.value)!==void 0?($=f.currentTarget)==null?void 0:$.value:f;e.setValue(i,p)},g=()=>{r==="BLUR"&&e.setTouched(i,!0)},h=()=>{r==="FOCUS"&&e.setTouched(i,!0)},{register:m,field:y}=e.registerField(i,{value:s.value,defaultValue:s.defaultValue,rules:s.rules,transform:s.transform,immediate:!1,onFocus:()=>{var f,p;(p=(f=o.value)==null?void 0:f.focus)==null||p.call(f)}}),V=a.computed(()=>y.state.value);return a.onMounted(()=>{m(),n.value=!0}),a.onUnmounted(()=>{e.unregisterField(i),o.value=null}),[a.reactive({value:V,onChange:u,onBlur:g,onFocus:h,ref:l}),{state:y.state,form:e,mounted:n}]},L=s=>{const t=a.inject(S,null),{form:e=t,name:i}=s,r=a.ref(!1);if(!e)throw new Error(`No form in the injected context or props, can not use Field <${s.name}>`);const{register:n,field:o}=e.registerVirtualField(i,{rules:s.rules,immediate:!1});return a.onMounted(()=>{n(),r.value=!0}),a.onUnmounted(()=>{e.unregisterField(i)}),[o.state,{mounted:r,form:e}]},k=()=>a.inject(S),tt=a.defineComponent({props:{form:{type:Object,default:void 0},name:{type:String,required:!0,default:""},rules:{type:Array,default:()=>[]},value:{type:[String,Number,Boolean,Array,Object,Symbol],default:void 0},defaultValue:{type:[String,Number,Boolean,Array,Object,Symbol],default:void 0},transform:{type:Function,default:void 0},touchType:{type:String,default:"BLUR"}},setup(s){const t=s,[e,{mounted:i,state:r}]=_(t);return(n,o)=>a.unref(i)?a.renderSlot(n.$slots,"default",{key:0,field:a.unref(e),state:a.unref(r)}):a.createCommentVNode("",!0)}}),et=a.defineComponent({props:{form:{type:Object,default:void 0},name:{type:String,default:void 0,required:!0},rules:{type:Array,default:()=>[]}},setup(s){const t=s,[e,{mounted:i}]=L(t);return(r,n)=>a.unref(i)?a.renderSlot(r.$slots,"default",{key:0,state:a.unref(e)}):a.createCommentVNode("",!0)}}),st=a.defineComponent({props:{form:null},setup(s){const t=s;return a.provide(S,t.form),(e,i)=>a.renderSlot(e.$slots,"default")}});c.Field=tt,c.FieldClass=j,c.FormClass=D,c.FormProvider=st,c.VirtualField=et,c.VirtualFieldClass=M,c.createForm=Y,c.useField=_,c.useForm=k,c.useVirtualField=L,c.validators=I,c.vfmInjectionKey=S,Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
