import{reactive as t,readonly as s,watchEffect as a,ref as i,toRaw as e}from"vue";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function l(t,s,a,i){return new(a||(a=Promise))((function(e,l){function r(t){try{d(i.next(t))}catch(s){l(s)}}function n(t){try{d(i.throw(t))}catch(s){l(s)}}function d(t){var s;t.done?e(t.value):(s=t.value,s instanceof a?s:new a((function(t){t(s)}))).then(r,n)}d((i=i.apply(t,s||[])).next())}))}class r{constructor(a,i){this.data=null,this.validate=null,this.validateCount=0,this.stopValidateWatcher=null,this.stopDirtyWatcher=null,this.form=a,this.name=i.name,this._data=t({name:this.name,value:void 0===i.value?i.defaultValue:i.value,defaultValue:i.defaultValue,error:{message:""},isError:!1,isValidating:!1,isDirty:!1,isTouched:!1,isChanged:!1}),this.data=s(this._data),this.validate=i.validate||null,this.initWatcher()}get state(){return this.data||(this.data=s(this._data)),this.data}initWatcher(){let t=null;this.stopValidateWatcher=a((()=>l(this,void 0,void 0,(function*(){this.validateCount++;const s=this.state.value,a=this.form.state,i=this.validateCount;this._data.isValidating=!0,null==t||t(),t=null;let e=null;if(this.validate){const i=this.validate(s,a);i instanceof Promise&&(t=i.cancel||null),e=(yield i)||null}if(i!==this.validateCount)return;this._data.isValidating=!1;const l=!!(null==e?void 0:e.message);l?(this._data.error||(this._data.error={message:""}),this._data.error.message=(null==e?void 0:e.message)||"",this._data.error.type=(null==e?void 0:e.type)||"default",this._data.error.types=null==e?void 0:e.types):this._data.error=null,this._data.isError=l})))),this.stopDirtyWatcher=a((()=>{this._data.isDirty=this._data.value!==this._data.defaultValue}))}onUnregister(){var t,s;null===(t=this.stopValidateWatcher)||void 0===t||t.call(this),null===(s=this.stopDirtyWatcher)||void 0===s||s.call(this)}onChange(t){if(void 0===t)return;const s=this.state.value!==t;this._data.value=t,this._data.isChanged=this._data.isChanged||s}onTouched(){this._data.isTouched=!0}reset(t){var s,a;this.validateCount++,null===(s=this.stopValidateWatcher)||void 0===s||s.call(this),null===(a=this.stopDirtyWatcher)||void 0===a||a.call(this),void 0!==t&&(this._data.defaultValue=t),this._data.error=null,this._data.isError=!1,this._data.isValidating=!1,this._data.isDirty=!1,this._data.isTouched=!1,this._data.isChanged=!1,this._data.value=this._data.defaultValue,this.initWatcher()}}class n{constructor(a,i){this.name="",this.data=null,this.validate=null,this.validateCount=0,this.stopValidateWatcher=null,this.form=a,this.name=i.name,this._data=t({name:this.name,error:{message:""},isError:!1,isValidating:!1}),this.data=s(this._data),this.validate=i.validate||null,this.initWatcher()}get state(){return this.data||(this.data=s(this._data)),this.data}initWatcher(){let t=null;this.stopValidateWatcher=a((()=>l(this,void 0,void 0,(function*(){this.validateCount++;const s=this.form.state,a=this.validateCount;this._data.isValidating=!0,null==t||t(),t=null;let i=null;if(this.validate){const a=this.validate(s);a instanceof Promise&&(t=a.cancel||null),i=(yield a)||null}if(a!==this.validateCount)return;this._data.isValidating=!1;const e=!!(null==i?void 0:i.message);e?(this._data.error||(this._data.error={message:""}),this._data.error.message=(null==i?void 0:i.message)||"",this._data.error.type=(null==i?void 0:i.type)||"default",this._data.error.types=null==i?void 0:i.types):this._data.error=null,this._data.isError=e}))))}onUnregister(){var t;null===(t=this.stopValidateWatcher)||void 0===t||t.call(this)}}const d=(t,s,a)=>{const i=s.split(".");let e=t;for(;i.length;){const t=i.shift();0===i.length?e[t]=a:"object"==typeof e[t]&&null!==e[t]||(e[t]=/^\d+$/.test(t)?[]:{}),e=e[t]}},h=(t,s)=>{const a=s.split(".");let i=t;for(;a.length&&i;){const t=a.shift();i="object"==typeof i&&null!==i?i[t]:void 0}return 0===a.length?i:void 0},o=(t,s)=>{const a=Object.keys(t),i=Object.keys(s);a.filter((t=>!i.includes(t))).forEach((s=>{delete t[s]})),i.forEach((a=>{t[a]=s[a]}))};class u{constructor(s){this.fieldsKeys=i([]),this.fields=new Map,this.virtualFieldsKeys=i([]),this.virtualFields=new Map,this.data=null,this._fieldStates=t({}),this._fieldStatesReadonly=null,this.stopStateWatcher=null,this.stopStatusWatcher=null,this.stopValidatingWatcher=null,this.waiters=[],this.defaultValues={},this.defaultValues=s.defaultValues||{},this._data=t({values:e(this.defaultValues)||{},error:null,errors:{},virtualErrors:{},isError:!1,isValidating:!1,isDirty:!1,isTouched:!1,isChanged:!1,isSubmitted:!1,isSubmitting:!1,submitCount:0})}get state(){return this.data||(this.data=s(this._data)),this.data}get fieldStates(){return this._fieldStatesReadonly||(this._fieldStatesReadonly=s(this._fieldStates)),this._fieldStatesReadonly}mount(){this.stopStateWatcher=a((()=>{const t=this.virtualFieldsKeys.value;let s=!1,a=!1,i=!1,e=!1,l=!1;const r={},n={};let h=null;this.fieldsKeys.value.forEach((t=>{var o;const u=this.fields.get(t);u&&(d(r,t,u.state),d(n,t,u.state.error),d(this._data.values,t,u.state.value),u.state.isError&&(s=!0),u.state.isValidating&&(a=!0),u.state.isDirty&&(i=!0),u.state.isTouched&&(e=!0),u.state.isChanged||(l=!0),(null===(o=u.state.error)||void 0===o?void 0:o.message)&&!h&&(h=u.state.error))})),o(this._fieldStates,r),o(this._data.errors,n);const u={};t.forEach((t=>{var i;const e=this.virtualFields.get(t);e&&(d(u,t,e.state.error),e.state.isError&&(s=!0),e.state.isValidating&&(a=!0),(null===(i=e.state.error)||void 0===i?void 0:i.message)&&!h&&(h=e.state.error))})),o(this._data.virtualErrors,u),this._data.isError=s,this._data.error=h,this._data.isValidating=a,this._data.isDirty=i,this._data.isTouched=e,this._data.isChanged=l})),this.stopValidatingWatcher=a((()=>{this.state.isValidating||this.waiters.forEach((t=>{t()})),this.waiters=[]}))}unmount(){var t,s,a;null===(t=this.stopStateWatcher)||void 0===t||t.call(this),null===(s=this.stopStatusWatcher)||void 0===s||s.call(this),null===(a=this.stopValidatingWatcher)||void 0===a||a.call(this)}registerField(t,s={}){const{fieldsKeys:a,fields:i}=this;if(a.value.includes(t))throw`Duplicate field <${t}>.`;for(const r of a.value)if(r.startsWith(`${t}.`)||t.startsWith(`${r}.`))throw`Fields can not be nested together: <${t}> <${r}>.`;const e=h(this.state.values,t);let l=s.value;void 0===l&&(l=e),void 0===l&&(l=s.defaultValue);const n=void 0===e?s.defaultValue:e,d=new r(this,Object.assign(Object.assign({},s),{name:t,value:l,defaultValue:n}));i.set(t,d),this.fieldsKeys.value.push(t)}registerVirtualField(t,s={}){const{virtualFieldsKeys:a,virtualFields:i}=this;if(a.value.includes(t))throw`Duplicate virtual field <${t}>.`;const e=new n(this,Object.assign(Object.assign({},s),{name:t}));i.set(t,e),this.virtualFieldsKeys.value.push(t)}unregisterField(t){const{fields:s}=this,a=s.get(t);if(!a)throw`Field not exists <${t}>.`;a.onUnregister();const i=this.fieldsKeys.value.indexOf(t);-1!==i&&this.fieldsKeys.value.splice(i,1),((t,s)=>{const a=s.split(".");let i=t;for(;a.length&&"object"==typeof i&&null!==i;){const t=a.shift();0===a.length?delete i[t]:i=i[t]}})(this._data.values,t),s.delete(t)}unregisterVirtualField(t){const{virtualFields:s}=this,a=s.get(t);if(!a)throw`Virtual field not exists <${t}>.`;a.onUnregister();const i=this.virtualFieldsKeys.value.indexOf(t);-1!==i&&this.virtualFieldsKeys.value.splice(i,1),s.delete(t)}setValue(t,s){if(void 0===s)return;const a=this.fields.get(t);if(!a)throw`Field not exists <${t}>.`;a.onChange(s)}submit(t,s){const a=()=>{this._data.isSubmitting=!1,this.state.isError?s(e(this.state.errors)):(this._data.isSubmitted=!0,t(e(this.state.values)))};this._data.submitCount++,this._data.isSubmitting=!0,this.state.isValidating?this.waiters.push((()=>{a()})):a()}reset(t){this.waiters=[],this._data.values=void 0===t?this.defaultValues:t,this._data.errors={},this._data.isError=!1,this._data.isValidating=!1,this._data.isDirty=!1,this._data.isTouched=!1,this._data.isChanged=!1,this._data.isSubmitted=!1,this._data.isSubmitting=!1,this._data.submitCount=0;for(const[s,a]of this.fields){const t=h(this.state.values,s);a.reset(t)}}}const c=/^(?:[A-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[A-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9]{2,}(?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])$/i,v=t=>{if(t.length>3||0===t.length)return!1;if("0"===t[0]&&"0"!==t)return!1;if(!t.match(/^\d+$/))return!1;const s=+t;return s>=0&&s<=255},f=t=>t.toLowerCase().match(/^[0-9a-f]{2}$/),g={alpha:({name:t,value:s})=>{const a=`${t} is not alphabetical`;return"string"!=typeof s?a:/^[a-zA-Z]*$/.test(s)?"":a},alphaNum:({name:t,value:s})=>{const a=`${t} must be alpha-numeric`;return"string"!=typeof s&&"number"!=typeof s?a:/^[a-zA-Z0-9]*$/.test(`${s}`)?"":a},decimal:({name:t,value:s})=>{const a=`${t} must be decimal`;return"string"!=typeof s&&"number"!=typeof s?a:/^[-]?\d*(\.\d+)?$/.test(`${s}`)?"":a},email:({name:t,value:s})=>{const a=`${t} is not a valid email address`;return"string"!=typeof s?a:c.test(s)?"":a},integer:({name:t,value:s})=>{const a=`${t} is not an integer`;return"string"!=typeof s&&"number"!=typeof s?a:/(^[0-9]*$)|(^-[0-9]+$)/.test(`${s}`)?"":a},ipAddress:({name:t,value:s})=>{const a=`${t} is not a valid IP address`;if("string"!=typeof s)return a;const i=s.split(".");return 4===i.length&&i.every(v)?"":a},macAddress:({name:t,value:s})=>{const a=`${t} is not a valid MAC Address`;if("string"!=typeof s)return a;const i=s.split(":");return 6!==i.length&&8!==i.length||!i.every(f)?a:""},numeric:({name:t,value:s})=>{const a=`${t} must be numeric`;return"string"!=typeof s&&"number"!=typeof s?a:/^\d*(\.\d+)?$/.test(`${s}`)?"":a}};export{r as Field,u as Form,n as VirtualField,g as validators};
